<html>
  <head>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.26.0/babel.js"></script>
    <script crossorigin src="https://unpkg.com/react@15/dist/react.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@15/dist/react-dom.js"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/react-router/4.2.0/react-router.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/react-router-dom/4.2.2/react-router-dom.min.js'></script>
    <link href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css' rel='stylesheet' />
<style>
  .vertical-margin {
    margin: 10px 0;
  }
</style>
  </head>
  <body>
    <div id='root'></div>
  </body>

  <script type='text/babel'>
    const { Component } = React;
    const { render } = ReactDOM;
    const { HashRouter, Route, Switch, Link } = ReactRouterDOM; 
    const Router = HashRouter;

    class AppGenerator{
      static Component(model){
        return `
          const ${model.name} = () => {
            return (
              <div className='well'>
                ${model.name}
              </div>
            );
          };
        `;
      }
      static Components(models){
        return `
          ${ models.map( model => AppGenerator.Component(model)).join('') }
          const Home = ()=> {
            return (
              <div className='well'>
                Home
              </div>
            );
          };
        `;
      }
      static Route(model){
        return `
          <Route path='/${model.name}' component={${ model.name }} />
        `;
      }
      static Routes(models){
        return `
          <Route component={ Nav } />
          <Route path='/' exact component={ Home } />
          ${ models.map( model => AppGenerator.Route(model)).join('') }
        `;
      }
      static Nav(models){
        return `
          const Nav = ()=> {
              return ( 
              <ul className='nav nav-tabs'>
                <li>
                  <Link to='/'>Home</Link>
                </li>
                ${ models.map( model => {
                  return (
                    `
                      <li>
                        <Link to='/${ model.name }'>${ model.name }</Link>
                      </li>
                    `
                  );
                }).join('')}
              </ul>
            );
          };
        `;
      }
      static scripts(){
        const script = 'script';
        return `
    <${script} src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js'></${script}>
    <${script} src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.26.0/babel.js"></${script}>
    <${script} crossorigin src="https://unpkg.com/react@15/dist/react.js"></${script}>
    <${script} crossorigin src="https://unpkg.com/react-dom@15/dist/react-dom.js"></${script}>
    <${script} src='https://cdnjs.cloudflare.com/ajax/libs/react-router/4.2.0/react-router.js'></${script}>
    <${script} src='https://cdnjs.cloudflare.com/ajax/libs/react-router-dom/4.2.2/react-router-dom.min.js'></${script}>
    <link href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css' rel='stylesheet' />
`;

      }
      static generate(str){
        const script = 'script';
        const app = JSON.parse(decodeURIComponent(str));
        const { name, models } = app;
        const iframe = $('#appFrame');
        const html = `
   <html> 
      <head>
        ${AppGenerator.scripts()}
      </head>
      <body>
        <div id='root'></div>
      </body>
      <${script} type='text/babel'>
        const { Link, HashRouter, Route, Switch } = ReactRouterDOM;
        const Router = HashRouter;
        ${AppGenerator.Nav( models )}
        ${AppGenerator.Components( models )}


        const root = document.getElementById('root');
        ReactDOM.render((
<Router>
<div>
${ AppGenerator.Routes(models)}
</div>
</Router>
), root);
      </${script}>
   </html>
        `;
const preview = html.replace(/</g, "&lt;");
$('#codePreview').html(preview);
iframe.attr(
   "src", "data:text/html;charset=utf-8," + 
   html
);
      }
    }

    const Home = ()=> {
      return (
        <div className='well'>Home</div>
      );
    }

    const defaultApp = `{
  "name": "greatest app ever!",
  "models": [
    {
      "name": "User",
      "attr": {
        "firstName": "string",
        "lastName": "string"
      }
    },
    {
      "name": "Thing",
      "attr": {
        "name": "string",
        "price": "integer"
      }
    }
  ]
}`;

  class Generated extends Component{
    constructor({ app }){
      super();
    }
    componentDidMount(){
      AppGenerator.generate(this.props.app);
    }
    shouldComponentUpdate(){
        return false;
    }
    render(){
      return (
        <div>
          <iframe id='appFrame' width='100%'>
          </iframe>
          <pre id='codePreview'>
          </pre>
        </div>
      );
    }
   }
    

    class Generator extends Component {
      constructor(props){
        super();
        let app = defaultApp;
        if(props.match.params.app){
          app = decodeURIComponent(props.match.params.app);
          AppGenerator.generate(props.match.params.app);
           
        }
        this.state = { app , error: {} };
        this.generate = this.generate.bind(this);
        this.onChange = this.onChange.bind(this);
      }
      onChange(ev){
        this.setState({ app: ev.target.value });
        try{
          JSON.parse(ev.target.value);
          this.setState({ error: {}});
        }
        catch(ex){
          this.setState({ error: { message: 'must be an object'}});
        }
      }
      componentWillReceiveProps(props){
        AppGenerator.generate(props.match.params.app);
      }
      generate(){
        const appParam = encodeURIComponent(JSON.stringify(JSON.parse(this.state.app)));
        this.props.history.push(`/generator/${appParam}`);
      }
      render(){
        const { generate, onChange } = this;
        const { app, error } = this.state;
        const pretty = (str)=> {
          try{
            return JSON.stringify(JSON.parse(str), null, 2);
          }
          catch(ex){
            return str;
          }
        }
        return (
          <div>
          <div className='well'>
            <textarea rows='10' className='form-control' onChange={ onChange } value={ pretty(app) }>
            </textarea>
            <button disabled={ error.message } className='btn btn-primary vertical-margin' onClick={ generate }>Generate App</button>
            {
              error.message && (
                <div className='alert alert-danger'>{ error.message }</div>
              )
            }
          </div>
          {
            !error.message && (
              <Generated app={ app }/>
            )
          }
          </div>
        );
      }
    }

    const Nav = ({ location })=> {
      const isSelected = (pathname, startsWith)=> {
        return location.pathname === pathname || ( startsWith && location.pathname.indexOf(pathname) === 0);
      }
      return (
            <div>
              <ul className='nav nav-tabs vertical-margin'>
                <li className={ isSelected('/') ? 'active' : '' }>
                  <Link to='/'>Home</Link>
                </li>
                <li className={ isSelected('/generator', true) ? 'active' : '' }>
                  <Link to='/generator'>Generator</Link>
                </li>
              </ul>
            </div>
      );
    }
    
    const App = ()=> {
      return (
        <Router>
          <div className='container'>
            <Route component={ Nav }  />
            <Switch>
              <Route path='/' exact component={ Home } />
              <Route path='/generator/:app?' component={ Generator } />
            </Switch>
          </div>
        </Router>
      );
    }
    render(<App />, document.getElementById('root'));
  </script>
</html>
